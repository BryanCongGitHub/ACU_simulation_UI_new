# 协议字段配置界面方案

## 目标
- 提供完整协议字段的静态浏览视图，直接来源于 `protocols/templates/acusim.yaml`，确保调试人员无需查阅外部文档即可了解字节定义。
- 支持选择性勾选发送/接收字段，使现有“发送配置”“运行监视”等界面按选择动态显示控件或列。
- 保持默认体验与当前版本一致；用户未保存自定义勾选时沿用旧有字段集合。

## 架构概览
1. **数据层**
   - 从模板加载时，扩展 `ProtocolTemplateLoader` 暴露 `send_layout`、`receive_common`、`categories` 的元数据结构。
   - 新增一个轻量数据类 `TemplateFieldMeta`，统一描述字节、位、标签、备注、类别等信息，方便界面使用。
   - 将用户勾选状态持久化到 `acu_config.json`（或新增 `protocol_field_prefs.json`），结构包含：
     ```json
     {
       "send": {"bool_commands": [8,0,...], "word_fields": [10,12,...]},
       "receive": {"INV": ["输出频率", ...], "CHU": [...], "BCC": [...]} 
     }
     ```
2. **服务层**
   - 在 `controllers` 下新增 `protocol_field_service.py`：负责读取模板、合并用户偏好、提供默认清单。
   - 暴露信号/回调，供界面在勾选变化后通知其他视图更新。
3. **界面层**
   - 新增 `gui/protocol_field_config.py`（独立窗口或 Tab）：
     - 左侧树形列表展示发送字段（按 `life_signal` / `timestamps` / `bool_bitsets` / `word_fields` 分组）。
     - 右侧切换卡展示接收字段（按类别 INV/CHU/BCC）和公共字段。
     - 每个字段行包含：字节、位、信号名、描述/备注、勾选框。
     - 底部按钮：“恢复默认”“保存并应用”“取消”。
   - 现有页面监听 `field_config_changed` 事件：
     - **发送配置页**：根据勾选集合渲染控件；未勾选字段隐藏或禁用。
     - **解析结果/监视页**：根据配置调整列显示或 tooltip。

## 迭代计划
1. **迭代一**：只读浏览
   - 完成模板元数据读取，渲染静态表格，无勾选交互。
   - 验证字段说明与文档一致。
2. **迭代二**：配置与持久化
   - 加入勾选逻辑、配置文件存取、恢复默认按钮。
   - 发送/接收页面响应配置变更。
3. **迭代三**：增强体验
   - 搜索/过滤、批量选择、导出 CSV 等辅助功能。
   - 考虑多模板支持（若未来新增其它协议）。

## 测试建议
- 单元测试：
  - 验证 `protocol_field_service` 在默认配置与自定义配置下输出一致性。
  - 确认配置持久化文件读写逻辑。
- UI 自动化（pytest-qt）：
  - 勾选字段后刷新发送预览，确认帧内容受影响。
  - 调整接收字段后，解析视图列数量与顺序更新正确。
- 回归测试：
  - 继续运行 `tests/template_protocol/test_template_protocol.py` 确认数据层改造不会破坏协议行为。
